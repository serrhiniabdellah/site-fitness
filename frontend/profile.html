<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Updated CSP to include all required sources -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://pro.fontawesome.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://pro.fontawesome.com https://unpkg.com https://fonts.googleapis.com; font-src 'self' https://pro.fontawesome.com https://unpkg.com https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self' ws://127.0.0.1:* wss://127.0.0.1:*;">
    <title>FitZone - My Profile</title>
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" />
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="login.css">
    <style>
        .profile-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .profile-sidebar {
            width: 25%;
            min-width: 250px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .profile-content {
            width: 70%;
            padding: 20px;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #088178;
            color: white;
            font-size: 48px;
            font-weight: 600;
        }
        
        .profile-name {
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .profile-menu {
            list-style: none;
            padding: 0;
        }
        
        .profile-menu li {
            padding: 10px 0;
            border-bottom: 1px solid #e1e1e1;
        }
        
        .profile-menu li:last-child {
            border-bottom: none;
        }
        
        .profile-menu a {
            color: #333;
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: 0.3s;
        }
        
        .profile-menu a i {
            margin-right: 10px;
            width: 20px;
        }
        
        .profile-menu a:hover {
            color: #088178;
        }
        
        .profile-menu a.active {
            color: #088178;
            font-weight: 600;
        }
        
        .profile-section {
            margin-bottom: 30px;
        }
        
        .profile-section h2 {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e1e1e1;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .form-group {
            width: 48%;
            margin-right: 4%;
            margin-bottom: 15px;
        }
        
        .form-group:nth-child(2n) {
            margin-right: 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e1e1e1;
            border-radius: 4px;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #088178;
        }
        
        .order-card {
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e1e1e1;
            border-radius: 5px;
            transition: 0.3s;
        }
        
        .order-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e1e1e1;
        }
        
        .order-date {
            color: #666;
        }
        
        .order-status {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-processing {
            background: #fff8dd;
            color: #ffc107;
        }
        
        .status-shipped {
            background: #e8f4fd;
            color: #0d6efd;
        }
        
        .status-delivered {
            background: #e6f7ee;
            color: #198754;
        }
        
        .order-products {
            margin: 15px 0;
        }
        
        .order-product {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .order-product-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        .order-product-details {
            flex-grow: 1;
        }
        
        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e1e1e1;
        }
        
        .order-total {
            font-weight: 600;
        }
        
        .btn {
            padding: 8px 20px;
            background: #088178;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .btn:hover {
            background: #066960;
        }
        
        .btn-outline {
            background: transparent;
            color: #088178;
            border: 1px solid #088178;
        }
        
        .btn-outline:hover {
            background: #088178;
            color: white;
        }
        
        @media (max-width: 768px) {
            .profile-sidebar,
            .profile-content {
                width: 100%;
            }
            
            .profile-sidebar {
                margin-bottom: 20px;
            }
            
            .form-group {
                width: 100%;
                margin-right: 0;
            }
        }
    </style>
</head>

<body>
    <section id="header">
        <a href="index.html"><img src="img/logo.png" class="logo" alt="FitZone Logo"></a>
        <div>
            <ul id="navbar">
                <li><a href="index.html">Home</a></li>
                <li><a href="shop.html">Shop</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li id="lg-bag"><a href="cart.html"><i class="far fa-shopping-bag"></i><span class="cart-count">0</span></a></li>
                <li id="lg-search"><a href="#" onclick="toggleSearchBar()"><i class="fas fa-search"></i></a></li>
                <li><a class="active" href="profile.html">My Account</a></li>
                <a href="#" id="close"><i class="far fa-times"></i></a>
            </ul>
        </div>
        <div id="search-container">
            <div class="search-wrapper">
                <input type="text" id="search-input" placeholder="Search for products...">
                <button id="search-button"><i class="fas fa-search"></i></button>
                <div id="search-results"></div>
            </div>
        </div>
        <div id="mobile">
            <a href="cart.html"><i class="far fa-shopping-bag"></i><span class="cart-count">0</span></a>
            <i class="fas fa-search" onclick="toggleSearchBar()"></i>
            <i id="bar" class="fas fa-outdent"></i>
        </div>
    </section>

    <section id="page-header" class="about-header">
        <h2>#MyAccount</h2>
        <p>Manage your profile and orders</p>
    </section>

    <section id="profile" class="section-p1">
        <div class="profile-container">
            <div class="profile-sidebar">
                <div class="profile-avatar" id="profile-avatar">
                    <!-- Initial will be set by JavaScript -->
                </div>
                <div class="profile-name" id="profile-name">
                    <!-- Name will be set by JavaScript -->
                </div>
                <ul class="profile-menu">
                    <li><a href="#" class="active" data-section="profile-info"><i class="fas fa-user"></i> Profile Information</a></li>
                    <li><a href="#" data-section="orders"><i class="fas fa-shopping-bag"></i> My Orders</a></li>
                    <li><a href="#" data-section="addresses"><i class="fas fa-map-marker-alt"></i> My Addresses</a></li>
                    <li><a href="#" data-section="security"><i class="fas fa-shield-alt"></i> Security</a></li>
                    <li><a href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                </ul>
            </div>
            
            <div class="profile-content">
                <!-- Profile Information Section -->
                <div class="profile-section" id="profile-info">
                    <h2>Profile Information</h2>
                    <form id="profile-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="first-name">First Name</label>
                                <input type="text" id="first-name" name="first_name" required>
                            </div>
                            <div class="form-group">
                                <label for="last-name">Last Name</label>
                                <input type="text" id="last-name" name="last_name" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="email">Email Address</label>
                                <input type="email" id="email" name="email" required>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone Number</label>
                                <input type="tel" id="phone" name="phone">
                            </div>
                        </div>
                        <div id="profile-message" style="margin-bottom: 15px;"></div>
                        <button type="submit" class="btn">Save Changes</button>
                    </form>
                </div>
                
                <!-- Orders Section -->
                <div class="profile-section" id="orders" style="display: none;">
                    <h2>My Orders</h2>
                    <div id="orders-list">
                        <p>Loading orders...</p>
                    </div>
                </div>
                
                <!-- Addresses Section -->
                <div class="profile-section" id="addresses" style="display: none;">
                    <h2>My Addresses</h2>
                    <div id="addresses-list">
                        <p>No saved addresses yet.</p>
                    </div>
                    <button class="btn" id="add-address-btn" style="margin-top: 15px;">Add New Address</button>
                </div>
                
                <!-- Security Section -->
                <div class="profile-section" id="security" style="display: none;">
                    <h2>Security</h2>
                    <form id="password-form">
                        <div class="form-group">
                            <label for="current-password">Current Password</label>
                            <input type="password" id="current-password" name="current_password" required>
                        </div>
                        <div class="form-group">
                            <label for="new-password">New Password</label>
                            <input type="password" id="new-password" name="new_password" required>
                        </div>
                        <div class="form-group">
                            <label for="confirm-password">Confirm New Password</label>
                            <input type="password" id="confirm-password" name="confirm_password" required>
                        </div>
                        <div id="password-message" style="margin-bottom: 15px;"></div>
                        <button type="submit" class="btn">Change Password</button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <section id="newsletter" class="section-p1 section-m1">
        <div class="newstext">
            <h4>Sign Up For Newsletters</h4>
            <p>Get E-mail updates about our latest products and <span>special offers.</span></p>
        </div>
        <div class="form">
            <input type="text" placeholder="Your email address">
            <button class="normal">Sign Up</button>
        </div>
    </section>

    <footer class="section-p1">
        <div class="col">
            <img class="logo" src="img/logo.png" alt="">
            <h4>Contact</h4>
            <p><strong>Address: </strong> 123 Fitness Street, Health District, Cityville</p>
            <p><strong>Phone:</strong> +1 234 567 8901 / +1 234 567 8902</p>
            <p><strong>Hours:</strong> 10:00 - 18:00, Mon - Sat</p>
            <div class="follow">
                <h4>Follow Us</h4>
                <div class="icon">
                    <i class="fab fa-facebook-f"></i>
                    <i class="fab fa-twitter"></i>
                    <i class="fab fa-instagram"></i>
                    <i class="fab fa-pinterest-p"></i>
                    <i class="fab fa-youtube"></i>
                </div>
            </div>
        </div>

        <div class="col">
            <h4>About</h4>
            <a href="about.html">About Us</a>
            <a href="#">Delivery Information</a>
            <a href="#">Privacy Policy</a>
            <a href="#">Terms & Conditions</a>
            <a href="contact.html">Contact Us</a>
        </div>

        <div class="col">
            <h4>My Account</h4>
            <a href="login.html">Sign In</a>
            <a href="cart.html">View Cart</a>
            <a href="#">My Wishlist</a>
            <a href="#">Track My Order</a>
            <a href="#">Help</a>
        </div>

        <div class="col install">
            <h4>Install App</h4>
            <p>From App Store or Google Play</p>
            <div class="row">
                <img src="img/pay/app.jpg" alt="">
                <img src="img/pay/play.jpg" alt="">
            </div>
            <p>Secured Payment Gateways </p>
            <img src="img/pay/pay.png" alt="">
        </div>

        <div class="copyright">
            <p>© 2025, FitZone - Premium Fitness Products & Supplements</p>
        </div>
    </footer>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Authentication check
            if (!FitZoneAuth.isLoggedIn()) {
                window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
                return;
            }
            
            const user = FitZoneAuth.getCurrentUser();
            
            // Set up profile avatar and name
            const profileAvatar = document.getElementById('profile-avatar');
            const profileName = document.getElementById('profile-name');
            
            if (user) {
                // Get initials for avatar
                const firstName = user.prenom || '';
                const lastName = user.nom || '';
                const initials = (firstName.charAt(0) + (lastName ? lastName.charAt(0) : '')).toUpperCase();
                
                profileAvatar.textContent = initials;
                profileName.textContent = `${firstName} ${lastName}`;
                
                // Fill in profile form
                document.getElementById('first-name').value = firstName;
                document.getElementById('last-name').value = lastName;
                document.getElementById('email').value = user.email || '';
                document.getElementById('phone').value = user.telephone || '';
            }
            
            // Profile menu navigation
            const menuItems = document.querySelectorAll('.profile-menu a[data-section]');
            const sections = document.querySelectorAll('.profile-section');
            
            menuItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all menu items
                    menuItems.forEach(item => item.classList.remove('active'));
                    
                    // Add active class to clicked menu item
                    this.classList.add('active');
                    
                    // Show the corresponding section
                    const sectionId = this.getAttribute('data-section');
                    
                    sections.forEach(section => {
                        section.style.display = section.id === sectionId ? 'block' : 'none';
                    });
                    
                    // Load section-specific data
                    if (sectionId === 'orders') {
                        loadOrders();
                    } else if (sectionId === 'addresses') {
                        loadAddresses();
                    }
                });
            });
            
            // Logout button
            document.getElementById('logout-button').addEventListener('click', function(e) {
                e.preventDefault();
                FitZoneAuth.logout();
            });
            
            // Profile form submission
            document.getElementById('profile-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const profileMessage = document.getElementById('profile-message');
                profileMessage.textContent = '';
                profileMessage.className = '';
                
                try {
                    const result = await FitZoneAuth.updateProfile({
                        first_name: document.getElementById('first-name').value,
                        last_name: document.getElementById('last-name').value,
                        email: document.getElementById('email').value,
                        phone: document.getElementById('phone').value
                    });
                    
                    profileMessage.textContent = 'Profile updated successfully!';
                    profileMessage.className = 'success-message';
                    
                    // Update display name and avatar
                    const firstName = document.getElementById('first-name').value;
                    const lastName = document.getElementById('last-name').value;
                    const initials = (firstName.charAt(0) + (lastName ? lastName.charAt(0) : '')).toUpperCase();
                    
                    profileAvatar.textContent = initials;
                    profileName.textContent = `${firstName} ${lastName}`;
                } catch (error) {
                    profileMessage.textContent = error.message || 'Failed to update profile';
                    profileMessage.className = 'error-message';
                }
            });
            
            // Password form submission
            document.getElementById('password-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const passwordMessage = document.getElementById('password-message');
                passwordMessage.textContent = '';
                passwordMessage.className = '';
                
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                if (newPassword !== confirmPassword) {
                    passwordMessage.textContent = 'New passwords do not match';
                    passwordMessage.className = 'error-message';
                    return;
                }
                
                if (newPassword.length < 8) {
                    passwordMessage.textContent = 'Password should be at least 8 characters long';
                    passwordMessage.className = 'error-message';
                    return;
                }
                
                try {
                    const result = await FitZoneAuth.changePassword({
                        current_password: currentPassword,
                        new_password: newPassword
                    });
                    
                    // Clear form
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                    
                    passwordMessage.textContent = 'Password updated successfully!';
                    passwordMessage.className = 'success-message';
                } catch (error) {
                    passwordMessage.textContent = error.message || 'Failed to change password';
                    passwordMessage.className = 'error-message';
                }
            });
            
            // Load orders
            async function loadOrders() {
                const ordersList = document.getElementById('orders-list');
                ordersList.innerHTML = '<p>Loading orders...</p>';
                
                try {
                    const API_URL = CONFIG.API_URL;
                    
                    const response = await fetch(`${API_URL}/orders/user.php`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: user.id_utilisateur,
                            token: user.token
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        if (result.orders && result.orders.length > 0) {
                            let ordersHtml = '';
                            
                            result.orders.forEach(order => {
                                const orderDate = new Date(order.date_commande).toLocaleDateString();
                                let statusClass = '';
                                
                                switch (order.statut_commande) {
                                    case 'processing':
                                        statusClass = 'status-processing';
                                        break;
                                    case 'shipped':
                                        statusClass = 'status-shipped';
                                        break;
                                    case 'delivered':
                                        statusClass = 'status-delivered';
                                        break;
                                    default:
                                        statusClass = '';
                                }
                                
                                ordersHtml += `
                                    <div class="order-card">
                                        <div class="order-header">
                                            <div>
                                                <strong>Order #${order.id_commande}</strong>
                                                <div class="order-date">${orderDate}</div>
                                            </div>
                                            <div class="order-status ${statusClass}">${order.statut_commande}</div>
                                        </div>
                                        <div class="order-footer">
                                            <div class="order-total">Total: $${parseFloat(order.total).toFixed(2)}</div>
                                            <a href="order-detail.html?id=${order.id_commande}" class="btn btn-outline">View Details</a>
                                        </div>
                                    </div>
                                `;
                            });
                            
                            ordersList.innerHTML = ordersHtml;
                        } else {
                            ordersList.innerHTML = '<p>You have no orders yet.</p>';
                        }
                    } else {
                        ordersList.innerHTML = `<p>Error loading orders: ${result.message}</p>`;
                    }
                } catch (error) {
                    console.error('Error loading orders:', error);
                    ordersList.innerHTML = '<p>Failed to load orders. Please try again later.</p>';
                }
            }
            
            // Load addresses
            function loadAddresses() {
                // This would be implemented similar to loadOrders, fetching from the backend
                // For now, we just show a placeholder
                const addressesList = document.getElementById('addresses-list');
                addressesList.innerHTML = '<p>No saved addresses yet.</p>';
            }
        });
    </script>
</body>

</html>
