<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitZone - Shop</title>
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" />
    <link rel="stylesheet" href="style.css">
    <style>
        #page-header.shop-header {
            background-image: url('img/banner/b1.jpg');
            background-size: cover;
            background-position: center;
            position: relative;
            z-index: 1;
        }
        
        #page-header.shop-header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: -1;
        }
        
        #page-header h2, 
        #page-header p {
            color: #fff;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body>

    <section id="header">
        <a href="#"><img src="img/logo.png" class="logo" alt=""></a>

        <div>
            <ul id="navbar">
                <li><a href="index.html">Home</a></li>
                <li><a class="active" href="shop.html">Shop</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li id="lg-bag"><a href="cart.html"><i class="far fa-shopping-bag"></i></a></li>
                <li id="lg-search"><a href="#" onclick="toggleSearchBar()"><i class="fas fa-search"></i></a></li>
                <li><a href="login.html">Login</a></li>
                <a href="#" id="close"><i class="far fa-times"></i></a>
            </ul>
        </div>
        <div id="search-container">
            <div class="search-wrapper">
                <input type="text" id="search-input" placeholder="Rechercher des produits...">
                <button id="search-button"><i class="fas fa-search"></i></button>
                <div id="search-results"></div>
            </div>
        </div>
        <div id="mobile">
            <a href="cart.html"><i class="far fa-shopping-bag"></i></a>
            <i class="fas fa-search" onclick="toggleSearchBar()"></i>
            <i id="bar" class="fas fa-outdent"></i>
        </div>
    </section>

    <section id="page-header" class="shop-header">
        <h2>#FitGoals</h2>
        <p>Premium fitness supplements & equipment to reach your goals!</p>
    </section>

    <!-- Filter and Sort Section -->
    <section id="shop-controls" class="section-p1">
        <div class="filter-sort-container">
            <div class="filter-section">
                <h4>Filter By:</h4>
                <div class="filter-options">
                    <div class="filter-group">
                        <label>Category:</label>
                        <select id="category-filter">
                            <option value="">All Categories</option>
                            <option value="1">Protéines</option>
                            <option value="2">Mass Gainers</option>
                            <option value="3">BCAA & Acides Aminés</option>
                            <option value="4">Équipement</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Price Range:</label>
                        <div class="price-range">
                            <input type="number" id="min-price" placeholder="Min" min="0">
                            <span>to</span>
                            <input type="number" id="max-price" placeholder="Max" min="0">
                        </div>
                    </div>
                    <div class="filter-group">
                        <label>Special Offers:</label>
                        <div class="checkbox-group">
                            <input type="checkbox" id="promo-filter">
                            <label for="promo-filter">On Sale</label>
                        </div>
                    </div>
                </div>
                <button id="apply-filters" class="filter-btn">Apply Filters</button>
                <button id="reset-filters" class="filter-btn secondary">Reset</button>
            </div>
            
            <div class="sort-section">
                <h4>Sort By:</h4>
                <select id="sort-by">
                    <option value="id_produit-ASC">Default</option>
                    <option value="prix-ASC">Price: Low to High</option>
                    <option value="prix-DESC">Price: High to Low</option>
                    <option value="nom_produit-ASC">Name: A-Z</option>
                    <option value="nom_produit-DESC">Name: Z-A</option>
                    <option value="date_creation-DESC">Newest First</option>
                </select>
            </div>
        </div>
    </section>

    <!-- Products Section -->
    <section id="product1" class="section-p1">
        <div class="pro-container" id="products-container">
            <!-- Products will be loaded dynamically here -->
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Loading products...</span>
            </div>
        </div>
    </section>

    <!-- Pagination Section -->
    <section id="pagination" class="section-p1">
        <!-- Pagination will be generated dynamically -->
    </section>

    <section id="newsletter" class="section-p1 section-m1">
        <div class="newstext">
            <h4>Sign Up For Newsletters</h4>
            <p>Get E-mail updates about our latest products and <span>special offers.</span></p>
        </div>
        <div class="form">
            <input type="text" placeholder="Your email address">
            <button class="normal">Sign Up</button>
        </div>
    </section>

    <footer class="section-p1">
        <div class="col">
            <img class="logo" src="img/logo.png" alt="">
            <h4>Contact</h4>
            <p><strong>Address: </strong> 123 Fitness Street, Health District, Cityville</p>
            <p><strong>Phone:</strong> +1 234 567 8901 / +1 234 567 8902</p>
            <p><strong>Hours:</strong> 10:00 - 18:00, Mon - Sat</p>
            <div class="follow">
                <h4>Follow Us</h4>
                <div class="icon">
                    <i class="fab fa-facebook-f"></i>
                    <i class="fab fa-twitter"></i>
                    <i class="fab fa-instagram"></i>
                    <i class="fab fa-pinterest-p"></i>
                    <i class="fab fa-youtube"></i>
                </div>
            </div>
        </div>

        <div class="col">
            <h4>About</h4>
            <a href="about.html">About Us</a>
            <a href="#">Delivery Information</a>
            <a href="#">Privacy Policy</a>
            <a href="#">Terms & Conditions</a>
            <a href="contact.html">Contact Us</a>
        </div>

        <div class="col">
            <h4>My Account</h4>
            <a href="login.html">Sign In</a>
            <a href="cart.html">View Cart</a>
            <a href="#">My Wishlist</a>
            <a href="#">Track My Order</a>
            <a href="#">Help</a>
        </div>

        <div class="col install">
            <h4>Install App</h4>
            <p>From App Store or Google Play</p>
            <div class="row">
                <img src="img/pay/app.jpg" alt="">
                <img src="img/pay/play.jpg" alt="">
            </div>
            <p>Secured Payment Gateways </p>
            <img src="img/pay/pay.png" alt="">
        </div>

        <div class="copyright">
            <p>© 2025, FitZone - Premium Fitness Products & Supplements</p>
        </div>
    </footer>

    <script src="script.js"></script>

    <script>
        // Shop Page JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            const API_URL = 'http://localhost/site%20fitness/backend/api';
            
            // DOM Elements
            const productsContainer = document.getElementById('products-container');
            const paginationContainer = document.getElementById('pagination');
            const categoryFilter = document.getElementById('category-filter');
            const minPriceFilter = document.getElementById('min-price');
            const maxPriceFilter = document.getElementById('max-price');
            const promoFilter = document.getElementById('promo-filter');
            const sortBySelect = document.getElementById('sort-by');
            const applyFiltersBtn = document.getElementById('apply-filters');
            const resetFiltersBtn = document.getElementById('reset-filters');
            
            // State variables
            let currentPage = 1;
            let currentFilters = {};
            let currentSort = 'id_produit-ASC';
            
            // Parse URL parameters
            function getUrlParams() {
                const params = new URLSearchParams(window.location.search);
                const urlParams = {};
                
                if (params.has('category')) urlParams.category = params.get('category');
                if (params.has('min_price')) urlParams.min_price = params.get('min_price');
                if (params.has('max_price')) urlParams.max_price = params.get('max_price');
                if (params.has('promotion')) urlParams.promotion = params.get('promotion') === '1';
                if (params.has('search')) urlParams.search = params.get('search');
                if (params.has('page')) urlParams.page = parseInt(params.get('page'));
                if (params.has('sort')) {
                    const sortParams = params.get('sort').split('-');
                    urlParams.sort_by = sortParams[0];
                    urlParams.sort_order = sortParams[1];
                }
                
                return urlParams;
            }
            
            // Apply URL parameters to filters
            function applyUrlParamsToFilters() {
                const params = getUrlParams();
                
                if (params.category) categoryFilter.value = params.category;
                if (params.min_price) minPriceFilter.value = params.min_price;
                if (params.max_price) maxPriceFilter.value = params.max_price;
                if (params.promotion) promoFilter.checked = true;
                if (params.sort_by && params.sort_order) {
                    sortBySelect.value = `${params.sort_by}-${params.sort_order}`;
                }
                
                // Set current page
                if (params.page) currentPage = params.page;
                
                // Set current filters
                currentFilters = {
                    category: params.category || '',
                    min_price: params.min_price || '',
                    max_price: params.max_price || '',
                    promotion: params.promotion ? 1 : 0,
                    search: params.search || ''
                };
                
                // Set current sort
                if (params.sort_by && params.sort_order) {
                    currentSort = `${params.sort_by}-${params.sort_order}`;
                }
            }
            
            // Load products from API
            async function loadProducts() {
                // Show loading spinner
                productsContainer.innerHTML = `
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Loading products...</span>
                    </div>
                `;
                
                // Build query parameters
                const sortParams = currentSort.split('-');
                const queryParams = new URLSearchParams({
                    page: currentPage,
                    limit: 12
                });
                
                // Add filter parameters
                if (currentFilters.category) queryParams.append('category', currentFilters.category);
                if (currentFilters.min_price) queryParams.append('min_price', currentFilters.min_price);
                if (currentFilters.max_price) queryParams.append('max_price', currentFilters.max_price);
                if (currentFilters.promotion) queryParams.append('promotion', currentFilters.promotion);
                if (currentFilters.search) queryParams.append('search', currentFilters.search);
                
                // Add sort parameters
                queryParams.append('sort_by', sortParams[0]);
                queryParams.append('sort_order', sortParams[1]);
                
                try {
                    const response = await fetch(`${API_URL}/products.php?${queryParams.toString()}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        // Update window URL with filters
                        const newUrl = new URL(window.location);
                        newUrl.search = queryParams.toString();
                        window.history.pushState({ path: newUrl.pathname + newUrl.search }, '', newUrl.pathname + newUrl.search);
                        
                        // Render products
                        renderProducts(data.products);
                        
                        // Render pagination
                        renderPagination(data.pagination);
                    } else {
                        productsContainer.innerHTML = `
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                <span>Error loading products: ${data.message}</span>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading products:', error);
                    productsContainer.innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-circle"></i>
                            <span>Error loading products. Please try again later.</span>
                        </div>
                    `;
                }
            }
            
            // Render products
            function renderProducts(products) {
                if (products.length === 0) {
                    productsContainer.innerHTML = `
                        <div class="no-products-message">
                            <i class="fas fa-search"></i>
                            <span>No products found matching your criteria.</span>
                            <button id="clear-filters" class="normal">Clear Filters</button>
                        </div>
                    `;
                    
                    // Add event listener to clear filters button
                    const clearFiltersBtn = document.getElementById('clear-filters');
                    if (clearFiltersBtn) {
                        clearFiltersBtn.addEventListener('click', resetFilters);
                    }
                    
                    return;
                }
                
                productsContainer.innerHTML = products.map(product => `
                    <div class="pro" data-id="${product.id_produit}">
                        <img src="${product.image || 'img/products/default.jpg'}" alt="${product.nom_produit}">
                        <div class="des">
                            <span>${product.nom_categorie}</span>
                            <h5>${product.nom_produit}</h5>
                            <div class="star">
                                ${renderStarRating(product.average_rating || 0)}
                            </div>
                            <h4>$${parseFloat(product.prix).toFixed(2)}</h4>
                            ${product.est_promotion ? 
                                `<span class="promotion-badge">Sale</span>` : ''}
                        </div>
                        <a href="sproduct.html?id=${product.id_produit}" class="view-product">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="#" class="add-to-cart-btn" data-id="${product.id_produit}">
                            <i class="fal fa-shopping-cart cart"></i>
                        </a>
                    </div>
                `).join('');
                
                // Add click event listeners to product items
                document.querySelectorAll('.pro').forEach(product => {
                    product.addEventListener('click', function(e) {
                        // Only if not clicking on the cart icon
                        if (!e.target.closest('.add-to-cart-btn')) {
                            window.location.href = `sproduct.html?id=${this.getAttribute('data-id')}`;
                        }
                    });
                });
                
                // Add click event listeners to cart icons
                document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        const productId = this.getAttribute('data-id');
                        
                        FitZoneCart.addItem(productId, 1).then(result => {
                            if (result.success) {
                                alert('Product added to cart!');
                            } else {
                                alert(result.message || 'Failed to add product to cart');
                            }
                        });
                    });
                });
            }
            
            // Render star rating
            function renderStarRating(rating) {
                const fullStars = Math.floor(rating);
                const halfStar = rating % 1 >= 0.5;
                const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
                
                let stars = '';
                
                // Full stars
                for (let i = 0; i < fullStars; i++) {
                    stars += '<i class="fas fa-star"></i>';
                }
                
                // Half star
                if (halfStar) {
                    stars += '<i class="fas fa-star-half-alt"></i>';
                }
                
                // Empty stars
                for (let i = 0; i < emptyStars; i++) {
                    stars += '<i class="far fa-star"></i>';
                }
                
                return stars;
            }
            
            // Render pagination
            function renderPagination(pagination) {
                if (!pagination || pagination.total_pages <= 1) {
                    paginationContainer.innerHTML = '';
                    return;
                }
                
                let paginationHtml = '';
                
                // Previous page button
                if (pagination.page > 1) {
                    paginationHtml += `<a href="#" data-page="${pagination.page - 1}" class="prev-page"><i class="fal fa-long-arrow-alt-left"></i></a>`;
                }
                
                // Page numbers
                const startPage = Math.max(1, pagination.page - 2);
                const endPage = Math.min(pagination.total_pages, pagination.page + 2);
                
                for (let i = startPage; i <= endPage; i++) {
                    paginationHtml += `<a href="#" data-page="${i}" ${i === pagination.page ? 'class="active"' : ''}>${i}</a>`;
                }
                
                // Next page button
                if (pagination.page < pagination.total_pages) {
                    paginationHtml += `<a href="#" data-page="${pagination.page + 1}" class="next-page"><i class="fal fa-long-arrow-alt-right"></i></a>`;
                }
                
                paginationContainer.innerHTML = paginationHtml;
                
                // Add event listeners to pagination links
                paginationContainer.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        currentPage = parseInt(this.getAttribute('data-page'));
                        loadProducts();
                        // Scroll to top of products section
                        document.getElementById('product1').scrollIntoView({ behavior: 'smooth' });
                    });
                });
            }
            
            // Apply filters
            function applyFilters() {
                currentPage = 1; // Reset to first page when applying filters
                
                currentFilters = {
                    category: categoryFilter.value,
                    min_price: minPriceFilter.value,
                    max_price: maxPriceFilter.value,
                    promotion: promoFilter.checked ? 1 : 0
                };
                
                loadProducts();
            }
            
            // Reset filters
            function resetFilters() {
                categoryFilter.value = '';
                minPriceFilter.value = '';
                maxPriceFilter.value = '';
                promoFilter.checked = false;
                sortBySelect.value = 'id_produit-ASC';
                
                currentFilters = {};
                currentSort = 'id_produit-ASC';
                currentPage = 1;
                
                loadProducts();
            }
            
            // Initialize shop page
            function initShopPage() {
                // Apply URL parameters to filters
                applyUrlParamsToFilters();
                
                // Load products
                loadProducts();
                
                // Add event listeners
                applyFiltersBtn.addEventListener('click', applyFilters);
                resetFiltersBtn.addEventListener('click', resetFilters);
                
                // Update products when sort changes
                sortBySelect.addEventListener('change', function() {
                    currentSort = this.value;
                    currentPage = 1; // Reset to first page when sorting changes
                    loadProducts();
                });
            }
            
            // Initialize the shop page
            initShopPage();
        });
    </script>
</body>

</html>