<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitZone - Product Details</title>
    
    <!-- Add configuration script first to ensure it's available to other scripts -->
    <script src="js/config.js"></script>
    
    <!-- Load WebSocket fixes early -->
    <script src="js/global-websocket-fix.js"></script>
    <script src="chrome-extension-fix.js"></script>
    <script src="chrome-extension-reload-fix.js"></script>
    
    <!-- Add auth and CORS handlers -->
    <script src="js/cors-proxy.js"></script>
    <script src="js/auth-persistence.js"></script>
    <script src="js/auth-header.js"></script>
    <script src="js/auth.js"></script>
    
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://pro.fontawesome.com; style-src 'self' 'unsafe-inline' https://pro.fontawesome.com https://fonts.googleapis.com; font-src 'self' https://pro.fontawesome.com https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self' ws://127.0.0.1:* wss://127.0.0.1:* http://127.0.0.1:* http://localhost:*;">
    
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" />
    <link rel="stylesheet" href="style.css">
    
    <!-- Include cart service script -->
    <script src="js/cart-service.js"></script>
    <script src="js/global-cart.js"></script>
    
    <style>
        #prodetails {
            display: flex;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        #prodetails .single-pro-image {
            width: 40%;
            margin-right: 50px;
        }
        
        #prodetails .single-pro-details {
            width: 50%;
            padding-top: 30px;
        }
        
        #prodetails .single-pro-details h4 {
            padding: 40px 0 20px 0;
        }
        
        #prodetails .single-pro-details h2 {
            font-size: 26px;
        }
        
        #prodetails .single-pro-details select {
            display: block;
            padding: 5px 10px;
            margin-bottom: 10px;
        }
        
        #prodetails .single-pro-details input {
            width: 50px;
            height: 47px;
            padding-left: 10px;
            font-size: 16px;
            margin-right: 10px;
        }
        
        #prodetails .single-pro-details input:focus {
            outline: none;
        }
        
        #prodetails .single-pro-details button {
            background: #088178;
            color: #fff;
        }
        
        #prodetails .single-pro-details span {
            line-height: 25px;
        }
        
        .small-img-group {
            display: flex;
            justify-content: space-between;
        }
        
        .small-img-col {
            flex-basis: 24%;
            cursor: pointer;
        }
        
        .product-description {
            margin: 20px 0;
            line-height: 1.6;
        }
        
        .product-meta {
            margin: 20px 0;
            padding: 15px 0;
            border-top: 1px solid #e1e1e1;
            border-bottom: 1px solid #e1e1e1;
        }
        
        .product-meta span {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #606063;
        }
        
        .variant-selector {
            margin: 20px 0;
        }
        
        .variant-selector label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .reviews-section {
            margin: 40px 0;
        }
        
        .review {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .review-author {
            font-weight: 600;
        }
        
        .review-date {
            color: #606063;
            font-size: 14px;
        }
        
        .review-rating {
            color: #ffb900;
            margin-bottom: 10px;
        }
        
        .loading-container {
            text-align: center;
            padding: 40px;
        }
        
        .loading-spinner i {
            font-size: 40px;
            color: #088178;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            margin: 20px 0;
        }
        
        /* Account dropdown menu styling */
        .account-menu {
            position: relative;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #fff;
            min-width: 180px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            right: 0;
            border-radius: 4px;
        }
        
        .account-menu:hover .dropdown-content {
            display: block;
        }
        
        .dropdown-content a {
            color: #1a1a1a;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            font-size: 14px;
            border-radius: 0;
        }
        
        .dropdown-content a:hover {
            background-color: #f1f1f1;
            color: #088178;
        }
        
        .dropdown-content a:last-child {
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }
        
        .dropdown-content a:first-child {
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }
        
        @media (max-width: 799px) {
            #prodetails {
                flex-direction: column;
            }
            
            #prodetails .single-pro-image {
                width: 100%;
                margin-right: 0;
            }
            
            #prodetails .single-pro-details {
                width: 100%;
                padding-top: 20px;
            }
        }
    </style>
</head>

<body>
    <section id="header">
        <a href="index.html"><img src="img/logo.png" class="logo" alt="FitZone Logo"></a>
        <div>
            <ul id="navbar">
                <li><a href="index.html">Home</a></li>
                <li><a class="active" href="shop.html">Shop</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li id="lg-bag"><a href="cart.html"><i class="far fa-shopping-bag"></i><span class="cart-count">0</span></a></li>
                <li id="lg-search"><a href="#" onclick="toggleSearchBar()"><i class="fas fa-search"></i></a></li>
                <li class="account-menu" id="account-menu-login">
                    <a href="login.html">Login</a>
                </li>
                <li class="account-menu" id="account-menu-dropdown" style="display:none;">
                    <a href="profile.html" class="account-link">
                        <span id="user-name-nav">Account</span> <i class="fas fa-user"></i>
                    </a>
                    <div class="dropdown-content">
                        <a href="profile.html">My Profile</a>
                        <a href="orders.html">My Orders</a>
                        <a href="#" id="logout-link">Logout</a>
                    </div>
                </li>
                <a href="#" id="close"><i class="far fa-times"></i></a>
            </ul>
        </div>
        <div id="search-container">
            <div class="search-wrapper">
                <input type="text" id="search-input" placeholder="Search for products...">
                <button id="search-button"><i class="fas fa-search"></i></button>
                <div id="search-results"></div>
            </div>
        </div>
        <div id="mobile">
            <a href="cart.html"><i class="far fa-shopping-bag"></i><span class="cart-count">0</span></a>
            <i class="fas fa-search" onclick="toggleSearchBar()"></i>
            <i id="bar" class="fas fa-outdent"></i>
        </div>
    </section>

    <!-- Product Details Section -->
    <section id="prodetails" class="section-p1">
        <div id="product-loading" class="loading-container">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading product details...</p>
            </div>
        </div>
        
        <div id="product-error" class="error-message" style="display:none">
            <i class="fas fa-exclamation-circle"></i>
            <p id="error-message-text">Error loading product details.</p>
            <button onclick="window.location.reload()" class="normal">Retry</button>
        </div>
        
        <div id="product-container" style="display:none">
            <div class="single-pro-image">
                <img src="" width="100%" id="MainImg" alt="Product Image">
                <div class="small-img-group" id="product-thumbnails">
                    <!-- Thumbnails will be inserted here -->
                </div>
            </div>
            
            <div class="single-pro-details">
                <h6 id="product-category">Product Category</h6>
                <h4 id="product-name">Product Name</h4>
                <h2 id="product-price">$0.00</h2>
                
                <div id="variant-selector" class="variant-selector" style="display:none">
                    <label for="product-variant">Select Variant:</label>
                    <select name="variant" id="product-variant">
                        <!-- Variants will be inserted here -->
                    </select>
                </div>
                
                <div class="product-actions">
                    <label for="product-quantity">Quantity:</label>
                    <input type="number" id="product-quantity" value="1" min="1">
                    <button class="normal" id="add-to-cart-btn">Add To Cart</button>
                </div>
                
                <div class="product-description">
                    <h5>Product Description</h5>
                    <p id="product-description">Loading product description...</p>
                </div>
                
                <div class="product-meta">
                    <span id="product-sku">SKU: </span>
                    <span id="product-stock">Availability: </span>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Reviews Section -->
    <section id="reviews" class="section-p1 reviews-section">
        <h2>Customer Reviews</h2>
        <div id="reviews-loading" class="loading-container">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading reviews...</p>
            </div>
        </div>
        
        <div id="reviews-container" style="display:none">
            <!-- Reviews will be inserted here -->
        </div>
        
        <div id="no-reviews" style="display:none">
            <p>No reviews yet. Be the first to review this product!</p>
        </div>
    </section>

    <!-- Related Products Section -->
    <section id="product1" class="section-p1">
        <h2>Related Products</h2>
        <p>Recommended products based on your interest</p>
        <div id="related-loading" class="loading-container">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading related products...</p>
            </div>
        </div>
        <div class="pro-container" id="related-products">
            <!-- Related products will be inserted here -->
        </div>
    </section>

    <section id="newsletter" class="section-p1 section-m1">
        <div class="newstext">
            <h4>Sign Up For Newsletters</h4>
            <p>Get E-mail updates about our latest products and <span>special offers.</span></p>
        </div>
        <div class="form">
            <input type="text" placeholder="Your email address">
            <button class="normal">Sign Up</button>
        </div>
    </section>

    <footer class="section-p1">
        <div class="col">
            <img class="logo" src="img/logo.png" alt="">
            <h4>Contact</h4>
            <p><strong>Address: </strong> 123 Fitness Street, Health District, Cityville</p>
            <p><strong>Phone:</strong> +1 234 567 8901 / +1 234 567 8902</p>
            <p><strong>Hours:</strong> 10:00 - 18:00, Mon - Sat</p>
            <div class="follow">
                <h4>Follow Us</h4>
                <div class="icon">
                    <i class="fab fa-facebook-f"></i>
                    <i class="fab fa-twitter"></i>
                    <i class="fab fa-instagram"></i>
                    <i class="fab fa-pinterest-p"></i>
                    <i class="fab fa-youtube"></i>
                </div>
            </div>
        </div>

        <div class="col">
            <h4>About</h4>
            <a href="about.html">About Us</a>
            <a href="#">Delivery Information</a>
            <a href="#">Privacy Policy</a>
            <a href="#">Terms & Conditions</a>
            <a href="contact.html">Contact Us</a>
        </div>

        <div class="col">
            <h4>My Account</h4>
            <a href="login.html">Sign In</a>
            <a href="cart.html">View Cart</a>
            <a href="#">My Wishlist</a>
            <a href="#">Track My Order</a>
            <a href="#">Help</a>
        </div>

        <div class="col install">
            <h4>Install App</h4>
            <p>From App Store or Google Play</p>
            <div class="row">
                <img src="img/pay/app.jpg" alt="">
                <img src="img/pay/play.jpg" alt="">
            </div>
            <p>Secured Payment Gateways </p>
            <img src="img/pay/pay.png" alt="">
        </div>

        <div class="copyright">
            <p>© 2025, FitZone - Premium Fitness Products & Supplements</p>
        </div>
    </footer>

    <script src="js/auth-ui.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize product page immediately rather than waiting for CONFIG
            initProductPage();
            
            function initProductPage() {
                // Get product ID from URL query parameter
                const urlParams = new URLSearchParams(window.location.search);
                const productId = urlParams.get('id');
                
                if (!productId) {
                    showError('Product ID is missing.');
                    return;
                }
                
                // Get elements
                const productLoading = document.getElementById('product-loading');
                const productContainer = document.getElementById('product-container');
                const productError = document.getElementById('product-error');
                const errorText = document.getElementById('error-message-text');
                const reviewsLoading = document.getElementById('reviews-loading');
                const reviewsContainer = document.getElementById('reviews-container');
                const noReviews = document.getElementById('no-reviews');
                const relatedLoading = document.getElementById('related-loading');
                const relatedProducts = document.getElementById('related-products');
                
                // Show loading, hide other sections initially
                if (productLoading) productLoading.style.display = 'block';
                if (productContainer) productContainer.style.display = 'none';
                if (productError) productError.style.display = 'none';
                
                // Setup auth UI
                setupAuthUI();
                
                // Load product details
                fetchProductDetails(productId)
                    .then(product => {
                        displayProductDetails(product);
                        return product.id_categorie;
                    })
                    .then(categoryId => {
                        fetchRelatedProducts(productId, categoryId);
                    })
                    .catch(error => {
                        console.error('Error loading product details:', error);
                        showError(error.message || 'Failed to load product details. Please try again.');
                    });
                
                // Load reviews
                fetchProductReviews(productId)
                    .catch(error => {
                        console.error('Error loading reviews:', error);
                        if (reviewsLoading) reviewsLoading.style.display = 'none';
                        if (noReviews) {
                            noReviews.style.display = 'block';
                            noReviews.innerHTML = '<p>Unable to load reviews at this time. Please try again later.</p>';
                        }
                    });
                
                // Fetch product details from API
                async function fetchProductDetails(id) {
                    try {
                        const apiBaseUrl = window.CONFIG && window.CONFIG.API_URL ? 
                            window.CONFIG.API_URL : 'http://localhost/site_fitness/backend/api';
                        
                        const apiUrl = `${apiBaseUrl}/products/get.php?id=${id}`;
                        console.log('Fetching product from:', apiUrl);
                        
                        const response = await fetch(apiUrl);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (!data.success) {
                            throw new Error(data.message || 'Error fetching product details');
                        }
                        
                        return data.product;
                    } catch (error) {
                        console.error('Product fetch error:', error);
                        throw new Error('Failed to load product details. Please try again.');
                    }
                }
                
                // Display product details
                function displayProductDetails(product) {
                    // Hide loading, show product
                    if (productLoading) productLoading.style.display = 'none';
                    if (productContainer) productContainer.style.display = 'flex';
                    
                    // Set product details
                    document.getElementById('product-name').textContent = product.nom_produit;
                    document.getElementById('product-category').textContent = product.category_name || 'Fitness Products';
                    document.getElementById('product-price').textContent = `$${parseFloat(product.prix).toFixed(2)}`;
                    document.getElementById('product-description').textContent = product.description || 'No description available.';
                    document.getElementById('product-sku').textContent = `SKU: ${product.id_produit}`;
                    document.getElementById('product-stock').textContent = `Availability: ${product.stock > 0 ? 'In Stock' : 'Out of Stock'}`;
                    
                    // Set main image
                    const mainImg = document.getElementById('MainImg');
                    mainImg.src = product.image || 'img/products/default.jpg';
                    mainImg.alt = product.nom_produit;
                    
                    // Set thumbnails
                    const thumbnailsContainer = document.getElementById('product-thumbnails');
                    thumbnailsContainer.innerHTML = '';
                    
                    // If product has additional images
                    if (product.images && product.images.length > 0) {
                        product.images.slice(0, 4).forEach(image => {
                            const imgCol = document.createElement('div');
                            imgCol.className = 'small-img-col';
                            
                            const img = document.createElement('img');
                            img.src = image.image_url;
                            img.width = 100;
                            img.alt = product.nom_produit;
                            
                            imgCol.appendChild(img);
                            thumbnailsContainer.appendChild(imgCol);
                        });
                    } else {
                        // Use main image as thumbnail if no additional images
                        const imgCol = document.createElement('div');
                        imgCol.className = 'small-img-col';
                        
                        const img = document.createElement('img');
                        img.src = product.image || 'img/products/default.jpg';
                        img.width = 100;
                        img.alt = product.nom_produit;
                        
                        imgCol.appendChild(img);
                        thumbnailsContainer.appendChild(imgCol);
                    }
                    
                    // Handle variants if available
                    const variantSelector = document.getElementById('variant-selector');
                    const variantSelect = document.getElementById('product-variant');
                    
                    if (product.variants && product.variants.length > 0) {
                        variantSelector.style.display = 'block';
                        variantSelect.innerHTML = '';
                        
                        product.variants.forEach(variant => {
                            const option = document.createElement('option');
                            option.value = variant.id_variant;
                            option.textContent = `${variant.nom} - $${parseFloat(variant.prix).toFixed(2)}`;
                            variantSelect.appendChild(option);
                        });
                        
                        // Update price when variant changes
                        variantSelect.addEventListener('change', function() {
                            const selectedVariant = product.variants.find(v => v.id_variant == this.value);
                            if (selectedVariant) {
                                document.getElementById('product-price').textContent = `$${parseFloat(selectedVariant.prix).toFixed(2)}`;
                                document.getElementById('product-stock').textContent = `Availability: ${selectedVariant.stock > 0 ? 'In Stock' : 'Out of Stock'}`;
                            }
                        });
                    } else {
                        variantSelector.style.display = 'none';
                    }
                    
                    // Add to cart button event handler
                    const addToCartBtn = document.getElementById('add-to-cart-btn');
                    if (addToCartBtn) {
                        addToCartBtn.addEventListener('click', function() {
                            const quantity = parseInt(document.getElementById('product-quantity').value) || 1;
                            const variantId = variantSelect && variantSelect.style.display !== 'none' ? 
                                            parseInt(variantSelect.value) : null;
                            
                            addToCart(product, quantity, variantId);
                        });
                    }
                    
                    // Setup event listeners for product images
                    document.querySelectorAll('.small-img-col img').forEach(img => {
                        img.addEventListener('click', function() {
                            mainImg.src = this.src;
                        });
                    });
                }
                
                // Show error message
                function showError(message) {
                    if (productLoading) productLoading.style.display = 'none';
                    if (productContainer) productContainer.style.display = 'none';
                    if (productError) {
                        productError.style.display = 'block';
                        if (errorText) errorText.textContent = message;
                    }
                }
                
                // Fetch product reviews
                async function fetchProductReviews(productId) {
                    try {
                        if (reviewsLoading) reviewsLoading.style.display = 'block';
                        
                        const apiBaseUrl = window.CONFIG && window.CONFIG.API_URL ? 
                            window.CONFIG.API_URL : 'http://localhost/site_fitness/backend/api';
                        
                        const apiUrl = `${apiBaseUrl}/reviews/get.php?product_id=${productId}`;
                        console.log('Fetching reviews from:', apiUrl);
                        
                        const response = await fetch(apiUrl);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        
                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            const textResponse = await response.text();
                            console.error('Received non-JSON response:', textResponse);
                            throw new Error('Server returned non-JSON response');
                        }
                        
                        const data = await response.json();
                        if (reviewsLoading) reviewsLoading.style.display = 'none';
                        
                        if (data.success && data.reviews && data.reviews.length > 0) {
                            displayReviews(data.reviews);
                        } else {
                            if (noReviews) noReviews.style.display = 'block';
                        }
                    } catch (error) {
                        if (reviewsLoading) reviewsLoading.style.display = 'none';
                        if (noReviews) {
                            noReviews.style.display = 'block';
                            noReviews.innerHTML = '<p>Unable to load reviews at this time. Please try again later.</p>';
                        }
                        throw error;
                    }
                }
                
                // Display reviews
                function displayReviews(reviews) {
                    if (!reviewsContainer) return;
                    
                    reviewsContainer.innerHTML = '';
                    reviewsContainer.style.display = 'block';
                    
                    reviews.forEach(review => {
                        const reviewDiv = document.createElement('div');
                        reviewDiv.className = 'review';
                        
                        // Create stars based on rating
                        let stars = '';
                        const rating = parseFloat(review.note);
                        for (let i = 1; i <= 5; i++) {
                            if (i <= rating) {
                                stars += '<i class="fas fa-star"></i>';
                            } else if (i - 0.5 <= rating) {
                                stars += '<i class="fas fa-star-half-alt"></i>';
                            } else {
                                stars += '<i class="far fa-star"></i>';
                            }
                        }
                        
                        // Format date
                        const reviewDate = new Date(review.date_avis);
                        const formattedDate = reviewDate.toLocaleDateString();
                        
                        reviewDiv.innerHTML = `
                            <div class="review-header">
                                <span class="review-author">${review.prenom || 'Anonymous'}</span>
                                <span class="review-date">${formattedDate}</span>
                            </div>
                            <div class="review-rating">
                                ${stars} ${rating.toFixed(1)}
                            </div>
                            <div class="review-content">
                                <p>${review.commentaire || 'No comment provided.'}</p>
                            </div>
                        `;
                        
                        reviewsContainer.appendChild(reviewDiv);
                    });
                }
                
                // Fetch related products
                async function fetchRelatedProducts(productId, categoryId) {
                    try {
                        const apiBaseUrl = window.CONFIG && window.CONFIG.API_URL ? 
                            window.CONFIG.API_URL : 'http://localhost/site_fitness/backend/api';
                        
                        const apiUrl = `${apiBaseUrl}/products/related.php?id=${productId}&category=${categoryId || 0}`;
                        console.log('Fetching related products from:', apiUrl);
                        
                        const response = await fetch(apiUrl);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        if (relatedLoading) relatedLoading.style.display = 'none';
                        
                        if (data.success && data.products && data.products.length > 0) {
                            displayRelatedProducts(data.products);
                        } else {
                            if (relatedProducts) {
                                relatedProducts.innerHTML = '<p>No related products found.</p>';
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching related products:', error);
                        if (relatedLoading) relatedLoading.style.display = 'none';
                        if (relatedProducts) {
                            relatedProducts.innerHTML = '<p>Error loading related products.</p>';
                        }
                    }
                }
                
                // Display related products
                function displayRelatedProducts(products) {
                    if (!relatedProducts) return;
                    
                    relatedProducts.innerHTML = '';
                    
                    products.slice(0, 4).forEach(product => {
                        const productDiv = document.createElement('div');
                        productDiv.className = 'pro';
                        productDiv.setAttribute('data-id', product.id_produit);
                        
                        // Create stars based on rating
                        let stars = '';
                        const rating = parseFloat(product.rating || 4.5);
                        for (let i = 1; i <= 5; i++) {
                            if (i <= rating) {
                                stars += '<i class="fas fa-star"></i>';
                            } else if (i - 0.5 <= rating) {
                                stars += '<i class="fas fa-star-half-alt"></i>';
                            } else {
                                stars += '<i class="far fa-star"></i>';
                            }
                        }
                        
                        productDiv.innerHTML = `
                            <a href="sproduct.html?id=${product.id_produit}">
                                <img src="${product.image || 'img/products/default.jpg'}" alt="${product.nom_produit}">
                            </a>
                            <div class="des">
                                <span>${product.brand || 'FitZone'}</span>
                                <h5>${product.nom_produit}</h5>
                                <div class="star">${stars}</div>
                                <h4>$${parseFloat(product.prix).toFixed(2)}</h4>
                            </div>
                            <a href="#" class="cart add-to-cart-btn" data-id="${product.id_produit}">
                                <i class="fal fa-shopping-cart"></i>
                            </a>
                        `;
                        
                        relatedProducts.appendChild(productDiv);
                    });
                    
                    // Add click handlers for add-to-cart buttons
                    document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            const prodId = this.getAttribute('data-id');
                            
                            // Find product data from the related products array
                            const prod = products.find(p => p.id_produit == prodId);
                            if (prod) {
                                addToCart(prod, 1);
                            }
                        });
                    });
                }
                
                // Add to cart function
                function addToCart(product, quantity, variantId = null) {
                    try {
                        console.log("Adding to cart:", product, quantity, variantId);
                        
                        // Format product for CartService
                        const cartProduct = {
                            id: product.id_produit,
                            name: product.nom_produit,
                            price: parseFloat(product.prix),
                            image: product.image || 'img/products/default.jpg'
                        };
                        
                        // Use CartService if available
                        if (window.CartService && typeof window.CartService.addItem === 'function') {
                            window.CartService.addItem(cartProduct, quantity, variantId)
                                .then(() => {
                                    showAddedToCartMessage(product.nom_produit);
                                })
                                .catch(err => {
                                    console.error("Error adding item to cart:", err);
                                    alert("Failed to add item to cart. Please try again.");
                                });
                        } else {
                            // Fallback if CartService isn't available
                            console.warn("CartService not available, using basic cart functionality");
                            
                            // Simple cart implementation
                            let cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
                            
                            // Check if item already exists in cart
                            const existingItemIndex = cartItems.findIndex(item => 
                                item.id == product.id_produit && item.variant_id == variantId
                            );
                            
                            if (existingItemIndex !== -1) {
                                cartItems[existingItemIndex].quantity += quantity;
                            } else {
                                cartItems.push({
                                    id: product.id_produit,
                                    name: product.nom_produit,
                                    price: parseFloat(product.prix),
                                    image: product.image || 'img/products/default.jpg',
                                    quantity: quantity,
                                    variant_id: variantId
                                });
                            }
                            
                            localStorage.setItem('cartItems', JSON.stringify(cartItems));
                            showAddedToCartMessage(product.nom_produit);
                        }
                    } catch (err) {
                        console.error("Error in addToCart:", err);
                        alert("Failed to add item to cart. Please try again.");
                    }
                }
                
                // Show added to cart message
                function showAddedToCartMessage(productName) {
                    const toast = document.createElement('div');
                    toast.style.position = 'fixed';
                    toast.style.bottom = '30px';
                    toast.style.right = '30px';
                    toast.style.backgroundColor = '#088178';
                    toast.style.color = 'white';
                    toast.style.padding = '15px 25px';
                    toast.style.borderRadius = '5px';
                    toast.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                    toast.style.zIndex = '999';
                    toast.style.display = 'flex';
                    toast.style.alignItems = 'center';
                    toast.style.gap = '10px';
                    toast.style.transform = 'translateY(20px)';
                    toast.style.opacity = '0';
                    toast.style.transition = 'all 0.3s ease-in-out';
                    
                    toast.innerHTML = `
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <div style="font-weight:600">${productName} added to cart!</div>
                            <a href="cart.html" style="color:white;text-decoration:underline;display:inline-block;margin-top:5px;">View Cart</a>
                        </div>
                    `;
                    
                    document.body.appendChild(toast);
                    
                    setTimeout(() => {
                        toast.style.transform = 'translateY(0)';
                        toast.style.opacity = '1';
                    }, 100);
                    
                    setTimeout(() => {
                        toast.style.transform = 'translateY(20px)';
                        toast.style.opacity = '0';
                        setTimeout(() => {
                            document.body.removeChild(toast);
                        }, 300);
                    }, 3000);
                }
                
                // Setup auth UI
                function setupAuthUI() {
                    const isLoggedIn = typeof window.FitZoneAuth !== 'undefined' && window.FitZoneAuth.isLoggedIn && window.FitZoneAuth.isLoggedIn();
                    
                    const loginMenu = document.getElementById('account-menu-login');
                    const accountMenu = document.getElementById('account-menu-dropdown');
                    
                    if (isLoggedIn) {
                        // User is logged in
                        if (loginMenu) loginMenu.style.display = 'none';
                        if (accountMenu) accountMenu.style.display = 'block';
                        
                        try {
                            const user = window.FitZoneAuth.getCurrentUser();
                            const userNameNav = document.getElementById('user-name-nav');
                            if (userNameNav && user && user.prenom) {
                                userNameNav.textContent = user.prenom;
                            }
                        } catch (err) {
                            console.error("Error setting user name:", err);
                        }
                        
                        // Setup logout functionality
                        const logoutLink = document.getElementById('logout-link');
                        if (logoutLink) {
                            logoutLink.addEventListener('click', function(e) {
                                e.preventDefault();
                                
                                if (typeof window.FitZoneAuth !== 'undefined' && window.FitZoneAuth.logout) {
                                    window.FitZoneAuth.logout();
                                    window.location.href = 'index.html';
                                }
                            });
                        }
                    } else {
                        // User is not logged in
                        if (loginMenu) loginMenu.style.display = 'block';
                        if (accountMenu) accountMenu.style.display = 'none';
                    }
                }
            }
        });
    </script>

    <!-- Basic site scripts -->
    <script src="script.js"></script>
    <script src="js/header.js"></script>
    <script>
    // Initialize or ensure CartService is available
    document.addEventListener('DOMContentLoaded', function() {
        // Wait a moment to ensure CartService has loaded
        setTimeout(function() {
            // Check if CartService exists
            if (!window.CartService) {
                console.warn('CartService not found, initializing fallback cart system');
                
                // Create minimal CartService fallback
                window.CartService = {
                    getCart: async function() {
                        const cartData = localStorage.getItem('fitzone_cart') || '{"items":[],"total":0}';
                        return JSON.parse(cartData);
                    },
                    
                    addItem: async function(productId, quantity = 1, productData = {}) {
                        try {
                            // Get current cart
                            const cartData = localStorage.getItem('fitzone_cart') || '{"items":[],"total":0}';
                            const cart = JSON.parse(cartData);
                            
                            // Ensure productId is properly formatted
                            if (typeof productId === 'object' && productId.id) {
                                productData = productId;
                                productId = productId.id;
                            }
                            
                            // Find if product already exists
                            const existingItemIndex = cart.items.findIndex(item => {
                                return (item.id === productId || item.id_produit === productId);
                            });
                            
                            // Build item data
                            const item = {
                                id: productId,
                                id_produit: productId,
                                name: productData.name || productData.nom_produit || `Product ${productId}`,
                                price: parseFloat(productData.price || productData.prix || 0),
                                image: productData.image || 'img/products/default.jpg',
                                quantity: parseInt(quantity)
                            };
                            
                            // Update quantity or add new item
                            if (existingItemIndex !== -1) {
                                cart.items[existingItemIndex].quantity += parseInt(quantity);
                            } else {
                                cart.items.push(item);
                            }
                            
                            // Update total
                            cart.total = cart.items.reduce((sum, item) => {
                                return sum + (parseFloat(item.price) * parseInt(item.quantity));
                            }, 0);
                            
                            // Save cart
                            localStorage.setItem('fitzone_cart', JSON.stringify(cart));
                            console.log('Item added to cart using fallback method:', item);
                            
                            // Update cart count indicators
                            updateCartCount();
                            
                            return cart;
                        } catch (error) {
                            console.error('Error in fallback addItem:', error);
                            throw error;
                        }
                    }
                };
            } else {
                console.log('CartService is available, ready for use');
            }
            
            // Update cart count function
            window.updateCartCount = function() {
                try {
                    // Get cart
                    const cartData = localStorage.getItem('fitzone_cart') || '{"items":[],"total":0}';
                    const cart = JSON.parse(cartData);
                    
                    // Calculate total quantity
                    const totalQuantity = cart.items.reduce((sum, item) => {
                        return sum + parseInt(item.quantity || 1);
                    }, 0);
                    
                    // Update all cart count elements
                    const cartCountElements = document.querySelectorAll('.cart-count');
                    cartCountElements.forEach(element => {
                        element.textContent = totalQuantity;
                    });
                } catch (error) {
                    console.error('Error updating cart count:', error);
                }
            };
            
            // Initial cart count update
            updateCartCount();
        }, 500); // Wait 500ms to ensure all scripts are loaded
    });
</script>
</body>
</html>